<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brandium Navigasyon</title>
    <style>
        body {
            margin: 0; display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100vh; background: #121212; color: white;
            font-family: 'Segoe UI', sans-serif; overflow: hidden;
        }
        #status { font-size: 1.2rem; margin-bottom: 20px; text-align: center; }
        #arrow {
            width: 0; height: 0; 
            border-left: 35px solid transparent; border-right: 35px solid transparent;
            border-bottom: 70px solid #00d2ff;
            filter: drop-shadow(0 0 10px #00d2ff);
            transition: transform 0.05s linear; /* Yumuşak hareket için */
        }
        #success { font-size: 80px; display: none; color: #4cd137; }
        button {
            padding: 15px 30px; font-size: 18px; border-radius: 50px;
            border: none; background: #00d2ff; color: black; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,210,255,0.4);
        }
    </style>
</head>
<body>

    <div id="ui">
        <button id="startBtn">Sistemi Başlat</button>
    </div>

    <div id="status" style="display:none">Konum aranıyor...</div>
    <div id="arrow" style="display:none"></div>
    <div id="success">✔ Hedefe Vardınız</div>

    <script>
        // BRANDIUM AVM GÜNCEL KOORDİNAT (Ana Giriş Yakınları)
        const target = { lat: 40.982428, lon: 29.130761 }; 
        const threshold = 12; // Metre

        let userCoords = null;
        let lastBearing = 0;
        let lastCompass = 0;
        let filteredRotation = 0;

        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const arrow = document.getElementById('arrow');
        const success = document.getElementById('success');

        startBtn.onclick = () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') init();
                });
            } else {
                init();
            }
            startBtn.parentElement.style.display = 'none';
            status.style.display = 'block';
            arrow.style.display = 'block';
        };

        function init() {
            // Konum Takibi
            navigator.geolocation.watchPosition(pos => {
                userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                const dist = calculateDistance(userCoords.lat, userCoords.lon, target.lat, target.lon);
                
                status.innerHTML = `Uzaklık: <b>${Math.round(dist)}m</b>`;
                
                if (dist < threshold) {
                    arrow.style.display = 'none';
                    success.style.display = 'block';
                } else {
                    arrow.style.display = 'block';
                    success.style.display = 'none';
                }
            }, null, { enableHighAccuracy: true });

            // Pusula Takibi
            const handleRotate = (e) => {
                let heading = e.webkitCompassHeading || (360 - e.alpha);
                if (!heading) return;

                // TİTREME ÖNLEYİCİ FİLTRE (Low-Pass Filter)
                // Yeni değerin sadece %15'ini alarak ani sıçramaları engeller
                lastCompass = lastCompass + 0.15 * (heading - lastCompass);
                
                if (userCoords) {
                    const targetBearing = calculateBearing(userCoords.lat, userCoords.lon, target.lat, target.lon);
                    const finalRotation = targetBearing - lastCompass;
                    arrow.style.transform = `rotate(${finalRotation}deg)`;
                }
            };

            window.addEventListener('deviceorientation', handleRotate, true);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const p1 = lat1 * Math.PI/180;
            const p2 = lat2 * Math.PI/180;
            const dp = (lat2-lat1) * Math.PI/180;
            const dl = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dp/2)**2 + Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const l1 = lon1 * Math.PI/180;
            const l2 = lon2 * Math.PI/180;
            const p1 = lat1 * Math.PI/180;
            const p2 = lat2 * Math.PI/180;
            const y = Math.sin(l2-l1) * Math.cos(p2);
            const x = Math.cos(p1)*Math.sin(p2) - Math.sin(p1)*Math.cos(p2)*Math.cos(l2-l1);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
